<!--doctype html--> 
<script src="/socket.io.js"></script>
<script src="/socket.io-stream.js"></script>

<script src="/d3.min.js"></script> 
<script src="/d3.layout.min.js"></script>
<script src="/rickshaw.min.js"></script>

 <style type="text/css">
   .mainButtons {text-align: center;}
   #scanButton {margin-top:50px; width:400px; height:100px; color:blue;}
   #saveButton {margin-top:50px; width:100px; height:100px; color:red;}
 </style>

<div id="chart"></div>

<div class="mainButtons">
  <button id="scanButton" onclick="gatherData()">READ SPECTRUM</button>
  <button id="saveButton" onclick="saveData()">SAVE</button>
</div>

<script> 

var _series =
[
  {
    color: 'rgba(48,48,48,0.8)',
    data: []
  }
]

var graphIndex = 0;

var graph = new Rickshaw.Graph({
  element: document.querySelector("#chart")
  // , width: 1000
  , height: 600
  , min: 0
  , max: 1.0
  , renderer: 'area'
  , series: _series
});

function addSeries() {
  var color = randomColor();

  _series.push({
    data:[]
  , color: color
  });

  graphIndex++;
}

function genNum(){
  return Math.floor(Math.random() * 256);
}

function randomColor(){
  return 'rgba('+genNum()+','+genNum()+','+genNum()+',0.8)'
}

graph.renderer.unstack = true;
graph.render();

var socket = io();

function gatherData() {
  !socket.connected && socket.io.reconnect();

  socket.emit('scan');
}

ss(socket).on('graph',{objectMode:true}, function(stream) {

  stream.on('data', function(data) {
    graph.series[graphIndex].data.push(data);
    graph.update();
  })

});

socket.on('done',function(){
  socket.io.disconnect();
  addSeries();
});

function saveData(){
  socket.emit('save');
}

</script>